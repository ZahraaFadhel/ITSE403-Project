name: Pull Request Validation

on:
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        java: [17]

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: 17
        distribution: 'temurin'

    - name: Verify Java
      run: |
        java -version
        javac -version

    - name: Download JUnit 5
      run: |
        mkdir -p lib
        curl -L https://repo1.maven.org/maven2/org/junit/platform/junit-platform-console-standalone/1.9.3/junit-platform-console-standalone-1.9.3.jar -o lib/junit-platform-console-standalone.jar

    - name: Compile main code
      run: |
        find src -name "*.java" > sources.txt || echo "No main sources found"
        if [ -s sources.txt ]; then
          javac -d bin -encoding UTF-8 @sources.txt
        fi

    - name: Compile tests
      shell: bash
      run: |
        find tests -name "*.java" > test-sources.txt || true
        find . -path "*-randoop/*.java" >> test-sources.txt || true
        
        if [ -s test-sources.txt ]; then
          javac -d bin-tests -encoding UTF-8 -cp "bin:lib/junit-platform-console-standalone.jar" @test-sources.txt
        else
          echo "::warning::No test sources found"
        fi

    - name: Run tests (JUnit 5)
      shell: bash
      run: |
        CLASS_PATH="bin:bin-tests:lib/junit-platform-console-standalone.jar"
        
        # Discover and run tests
        java -jar lib/junit-platform-console-standalone.jar \
          --class-path "$CLASS_PATH" \
          --scan-class-path \
          --fail-if-no-tests \
          --details tree