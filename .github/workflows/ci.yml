name: Pull Request Validation

on:
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        java: [17]

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: 17
        distribution: 'temurin'

    - name: Download JUnit 5
      run: |
        mkdir -p lib
        curl -L https://repo1.maven.org/maven2/org/junit/platform/junit-platform-console-standalone/1.9.3/junit-platform-console-standalone-1.9.3.jar -o lib/junit-platform.jar

    - name: Compile main code
      run: |
        find src -name "*.java" > sources.txt || echo "No main sources found"
        [ -s sources.txt ] && javac -d bin -encoding UTF-8 @sources.txt

    - name: Compile tests
      run: |
        find tests -name "*.java" > test-sources.txt || echo "No tests found"
        if [ -s test-sources.txt ]; then
          javac -d bin-tests -encoding UTF-8 -cp "bin:lib/junit-platform.jar" @test-sources.txt
        else
          echo "::error::No test files found in tests/"
          exit 1
        fi

    - name: Run tests
      run: |
        CLASS_PATH="bin:bin-tests:lib/junit-platform.jar"
        java -jar lib/junit-platform.jar \
          --class-path "$CLASS_PATH" \
          --scan-class-path \
          --include-classname='.*' \
          --details tree